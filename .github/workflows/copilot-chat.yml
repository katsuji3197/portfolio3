name: Copilot Chat Integration

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: ['main']
  issue_comment:
    types: [created]

jobs:
  copilot-chat:
    name: Copilot Chat Integration
    runs-on: ubuntu-latest
    if: contains(github.event.comment.body, '@copilot') || github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Analyze PR Changes
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            // å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ†æ
            const changedFiles = files.map(file => file.filename);
            const addedLines = files.reduce((sum, file) => sum + file.additions, 0);
            const deletedLines = files.reduce((sum, file) => sum + file.deletions, 0);

            // è¤‡é›‘åº¦ã®åˆ†æ
            const complexFiles = files.filter(file => file.additions > 50 || file.deletions > 50);
            const newFiles = files.filter(file => file.status === 'added');
            const modifiedFiles = files.filter(file => file.status === 'modified');

            // Copilotãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã®ä½œæˆ
            const reviewComment = `## ğŸ¤– Copilot è‡ªå‹•åˆ†æçµæœ

            ### ğŸ“Š å¤‰æ›´çµ±è¨ˆ
            - å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«æ•°: **${changedFiles.length}**
            - è¿½åŠ ã•ã‚ŒãŸè¡Œæ•°: **${addedLines}**
            - å‰Šé™¤ã•ã‚ŒãŸè¡Œæ•°: **${deletedLines}**
            - æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«: **${newFiles.length}**
            - ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«: **${modifiedFiles.length}**

            ### âš ï¸ æ³¨æ„ãŒå¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«
            ${complexFiles.length > 0 ? 
              complexFiles.map(file => `- \`${file.filename}\` (${file.additions}è¡Œè¿½åŠ , ${file.deletions}è¡Œå‰Šé™¤)`).join('\n') : 
              'ç‰¹ã«ãªã—'
            }

            ### ğŸ” ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«
            ${changedFiles.map(file => `- \`${file}\``).join('\n')}

            ### ğŸ’¡ Copilotãƒ¬ãƒ“ãƒ¥ãƒ¼ä¾é ¼
            ã“ã®PRã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„ï¼š

            \`\`\`
            @copilot ã“ã®PRã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ã€ä»¥ä¸‹ã®è¦³ç‚¹ã‹ã‚‰åˆ†æã—ã¦ãã ã•ã„ï¼š
            1. ã‚³ãƒ¼ãƒ‰ã®å“è³ªã¨å¯èª­æ€§
            2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®å•é¡Œ
            3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®æ”¹å–„ç‚¹
            4. ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã®é©ç”¨
            5. ãƒ†ã‚¹ãƒˆã®ç¶²ç¾…æ€§
            \`\`\`

            ---
            *ã“ã®åˆ†æã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™ã€‚è©³ç´°ãªãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯Copilot Chatã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: reviewComment
            });

      - name: Respond to Copilot Mentions
        if: github.event_name == 'issue_comment' && contains(github.event.comment.body, '@copilot')
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const comment = context.payload.comment.body;
            const issueNumber = context.payload.issue.number;

            // Copilotãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã¸ã®å¿œç­”
            const response = `## ğŸ¤– Copilot å¿œç­”

            ã“ã‚“ã«ã¡ã¯ï¼PRã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¾é ¼ã‚’å—ã‘å–ã‚Šã¾ã—ãŸã€‚

            ### ğŸ“‹ ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¾é ¼å†…å®¹
            ${comment.replace('@copilot', '').trim()}

            ### ğŸ”„ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
            1. **æ‰‹å‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼**: å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’è©³ç´°ã«ç¢ºèªã—ã¦ãã ã•ã„
            2. **ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ**: \`pnpm test\` ã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„
            3. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯**: \`pnpm audit\` ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„
            4. **å‹ãƒã‚§ãƒƒã‚¯**: \`pnpm type-check\` ã§å‹å®‰å…¨æ€§ã‚’ç¢ºèªã—ã¦ãã ã•ã„

            ### ğŸ’¡ ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ãƒã‚¤ãƒ³ãƒˆ
            - ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§ã¨ä¿å®ˆæ€§
            - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®é©åˆ‡æ€§
            - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¸ã®å½±éŸ¿
            - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®å•é¡Œ
            - ãƒ†ã‚¹ãƒˆã®ç¶²ç¾…æ€§

            ---
            *ã“ã®å¿œç­”ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™ã€‚è©³ç´°ãªãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯æ‰‹å‹•ã§è¡Œã£ã¦ãã ã•ã„ã€‚*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: response
            });
